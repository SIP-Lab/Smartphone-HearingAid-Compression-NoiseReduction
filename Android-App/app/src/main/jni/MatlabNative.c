//
//  This copyrighted © code is written for and is part of the book
//  Smartphone-Based Real-Time Digital Signal Processing
//
#include <jni.h>
#include <math.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include "CoderFile/VAD.h"
#include "CoderFile/SPL.h"
int MakeDecision(float P_dec, float L_dec, int NR_flag, int WDRC_flag, float VAD_T, int NR_threshold, int WDRC_low_threshold, int WDRC_upper_threshold);
int majorityElement(int* nums, int numsSize);

static int frameSize = 256;
static int order = 64;
static int DecisionRate = 200;
static float *buffer = NULL;
static float *Pbuffer = NULL;
static float *Lbuffer = NULL;
static int *Dbuffer = NULL;

static float coeffs1[] = { 5.57196413532837,-0.103107247646826,-0.135247613103773,-0.181666441913823,-0.232783561294340,-0.278302636826579,-0.309234867127543,-0.319561132821735,-0.307189243340669,-0.274044808388045,-0.225344568709029,-0.168284682500243,-0.110488737908352,-0.0585783920681499,-0.0171575317971249,0.0116336342204637,0.0279934390419380,0.0338947836680750,0.0322940737781491,0.0263375591964176,0.0187427894320116,0.0114495016422094,0.00554396267231466,0.00139030566661730,-0.00113221202916153,-0.00238373271571996,-0.00277662463349866,-0.00267114568521545,-0.00234257642218977,-0.00198951436469444,-0.00175307077248558,-0.00172978310818756,0.000619032009441689,0.00289858200749606,0.00262772764249992,0.00230178432405035,0.00193501250538430,0.00154902797951154,0.00116714340761744,0.000810698922354469,0.000496868925277644,0.000237475415075794,3.85091080676858e-05,-9.97696590456856e-05,-0.000182187812022071,-0.000217520904058268,-0.000216983499262937,-0.000192563833379202,-0.000155468761078900,-0.000114926506645106,-7.75090389582532e-05,-4.70110876394404e-05,-2.47991402066022e-05,-1.04574798819139e-05,-2.52951163499937e-06,8.19534193452487e-07,1.32633016375339e-06,3.70143025840708e-07,-1.10216607779323e-06,-2.53328584587376e-06,-3.66359074888134e-06,-4.43934456140216e-06,-4.94282490703935e-06,-5.34489447366615e-06 };
static float coeffs2[] = { 4.41022692217349,-1.83218821570241,-1.14432409976405,-0.580617087286439,-0.157017505211095,0.00148414177022644,-0.0215156526934754,-0.00988794772990446,0.00545006484553503,0.00574687346363515,0.0440372644150080,0.0393764562293766,-0.0164968541039581,-0.0357307019891628,-0.0341049533511123,-0.0291968685421956,-0.000694498225492946,0.0191786284674415,0.0150065060440227,0.0114651099434002,0.00763755880122057,0.000874686853812859,-0.000298847101476261,0.000205660230241862,-0.00102917160584027,-0.000878485590647716,-8.58976197461257e-05,0.000104454139073937,0.000282326401018419,0.000110838677895258,-0.000506023963440516,-0.00119495858757290,0.00202397776834040,0.00407558897994487,0.00169419615801297,0.000368996814660405,-0.000125456137367329,-0.000170161231899228,-0.000146111284474800,-0.000145591734854348,-0.000138513004161866,-0.000132001796819022,-8.90423007246042e-05,-1.07025287827290e-05,2.27742332447991e-05,-1.10931767455073e-06,-4.04659965672904e-05,-8.00061561399279e-05,-9.73184652198755e-05,-7.87276639137025e-05,-4.96514243496504e-05,-2.77420924374439e-05,-1.18599146308913e-05,-4.46411044429870e-06,-3.38122801471844e-06,-2.70946547856199e-06,-2.63160708929280e-06,-3.56909704731737e-06,-3.88172900372095e-06,-3.48137975175744e-06,-2.80030467891823e-06,-2.05308084742133e-06,-1.83327100211628e-06,-2.56112910945738e-06 };
static float coeffs3[] = { 2.63493719282854,0.138633028511956,0.0942553330069445,0.0250264343153435,-0.0579988563890564,-0.141615905792334,-0.212974375501713,-0.261908938899030,-0.282607209843184,-0.274302808833608,-0.240923106336041,-0.189862463159489,-0.130232183948758,-0.0710176841416795,-0.0195411871524149,0.0194953959433190,0.0442857348837014,0.0555826006062267,0.0559463647781379,0.0488309010706882,0.0377414986518035,0.0256263120720235,0.0145652369885544,0.00573009980793003,-0.000468657714809917,-0.00415174641085780,-0.00574317588543308,-0.00579407705754187,-0.00486960397082805,-0.00348516117041980,-0.00207108041951957,-0.000952030768736402,0.00146189673478503,0.00358231318915590,0.00370940332417159,0.00348931521185691,0.00300696900941720,0.00236439354326971,0.00166036933514000,0.000977805099210666,0.000377689733760123,-0.000102156935708808,-0.000445268740606838,-0.000652999859186959,-0.000740170265647461,-0.000730447799802093,-0.000651848500013780,-0.000532681514878182,-0.000398248017760720,-0.000268552093048827,-0.000157163255986957,-7.11996471776510e-05,-1.22245029363505e-05,2.22805169619450e-05,3.72467679527755e-05,3.84914558212712e-05,3.15564823639702e-05,2.10000097212726e-05,1.01061265613961e-05,9.02407010228146e-07,-5.64643478139296e-06,-9.37951512017254e-06,-1.06850084192200e-05,-1.02809898500488e-05 };
static float coeffs4[] = { 2.06008093014519,-0.698392054613850,-0.474672158586362,-0.280440239731934,-0.130738613574829,-0.0698809457294384,-0.0726297643905941,-0.0654900498194552,-0.0505835871007674,-0.0321818562200020,0.00191442426501821,0.0194852856864983,0.0133002994314038,0.0108150089730352,0.0103076764728013,0.00895828681757399,0.0138162018680287,0.0151344695563646,0.00895436657789266,0.00396940153770663,0.000884382250233794,-0.00110117850281000,-0.000625957338038389,0.000263178773512637,0.000312718982864960,0.000345771941764871,0.000450164277231775,0.000471458417630574,0.000415855218175609,0.000193225512720236,-0.000132256649597831,-0.000531425695441845,0.000803696780812269,0.00178802001257350,0.000843806384776033,0.000262158450024641,-2.93452410409512e-05,-0.000141595081800092,-0.000195970285697122,-0.000236786738878152,-0.000260352082346024,-0.000267013339375134,-0.000244347018442840,-0.000192477202963184,-0.000141565254772150,-0.000105694263676875,-7.90640794742503e-05,-5.95361253644400e-05,-4.11515362214177e-05,-1.97619179465591e-05,-2.60316559078100e-06,5.98677825926208e-06,8.60087753216682e-06,7.47286462878926e-06,5.22963756468403e-06,4.08727227754063e-06,3.70870295395009e-06,3.40744325262599e-06,3.23303054780566e-06,3.20148245516044e-06,3.22366469274193e-06,3.14791534909015e-06,2.79154414203897e-06,2.02541807470258e-06 };
static float coeffs5[] = { 0.877504499139835,-0.00450437615938012,-0.00911523928642912,-0.0158548171923995,-0.0235191534046961,-0.0307873719935134,-0.0364729559509123,-0.0397340998502340,-0.0402002152282843,-0.0379935525213476,-0.0336505063954400,-0.0279697624518946,-0.0218285039381479,-0.0160105608342326,-0.0110820442283417,-0.00733396252152889,-0.00479260134113259,-0.00328227845353379,-0.00251536067843168,-0.00218277956260650,-0.00202386000763491,-0.00186431717368613,-0.00162217014812071,-0.00128980710937812,-0.000904549952318381,-0.000519542351951251,-0.000182867217881749,7.24252319834560e-05,0.000229150128289681,0.000281787710451877,0.000231317684930906,8.14752820184725e-05,0.000739005117833869,0.00140208579343378,0.00121989365022149,0.00104739115975564,0.000884293691981410,0.000731160245983568,0.000589214642762881,0.000460107504465084,0.000345597962686985,0.000247184021486737,0.000165749318097852,0.000101306634958935,5.29013534814457e-05,1.86985786212708e-05,-3.76957489649178e-06,-1.72592460017228e-05,-2.44548169565529e-05,-2.76712981815402e-05,-2.86720154533812e-05,-2.86190136320873e-05,-2.81389439251850e-05,-2.74631138805857e-05,-2.65919104407292e-05,-2.54404630414713e-05,-2.39391817425105e-05,-2.20825077821077e-05,-1.99352210226607e-05,-1.76139709523841e-05,-1.52618274336901e-05,-1.30280306759288e-05,-1.10576456408447e-05,-9.49002626928104e-06 };
static float coeffs6[] = { 0.720880716351334,-0.241317543788798,-0.164369089419349,-0.0941267908399337,-0.0404124163029007,-0.0117470799971071,-0.00268656520922078,0.00149263836215616,0.00231174499498696,0.000864090580141344,0.000722830261762442,-0.00209750070074460,-0.00744742513590664,-0.00973464650284251,-0.00915952459538887,-0.00683787605345400,-0.00281192071236344,0.000343946026506982,0.00141968273455519,0.00171130277364993,0.00164214414592019,0.00133719257600005,0.00108286509022503,0.000762046745109286,0.000360210679397483,4.10533054853495e-05,-6.26514184756317e-05,8.77884792093895e-06,8.60237044098908e-05,9.30237512819566e-05,4.40399648657733e-05,-0.000114745981904252,0.000662013804154982,0.00120786454528457,0.000624912287697142,0.000255890700023111,6.48357259561364e-05,-5.96421628492683e-06,-1.89498979637080e-05,-1.09041188900860e-05,3.62798827519830e-06,1.51834747676635e-05,2.24753927995021e-05,2.52518141049330e-05,1.79260046680712e-05,1.37125358438224e-06,-1.70277092233634e-05,-3.18853457882407e-05,-3.92276427081673e-05,-3.80900203307485e-05,-3.22864002282874e-05,-2.55272989072367e-05,-1.92246016377726e-05,-1.40251666786674e-05,-1.00067835531930e-05,-7.01247893913231e-06,-5.09472131228548e-06,-4.17854181037280e-06,-3.85628523158965e-06,-3.61596851682739e-06,-3.21272058478178e-06,-2.71702143883959e-06,-2.27543161851473e-06,-2.08649370019021e-06 };



int Counter = 0;
int filter_final = 0;
float Psum = 0;
float Lsum = 0;
double P,L;
int WDRC_flag, NR_flag;
WDRC_flag = 0;
NR_flag = 0;

jfloatArray
Java_com_dsp_matlab_Filters_compute(JNIEnv *env, jobject thiz, jfloatArray input, jint Fs, jboolean overlap, jfloat VAD_T, jint NR_threshold, jint WDRC_low_threshold, jint WDRC_upper_threshold)
{
	float *_in = (*env)->GetFloatArrayElements(env, input, NULL);
	jfloatArray output = (*env)->NewFloatArray(env, frameSize);
	float *_output = (*env)->GetFloatArrayElements(env, output, NULL);


	int i, j;
	int idx = 0;
	int halfDecision = DecisionRate / 2;
	//VAD&SPL measure for frame
    double frame[256];
    for(i=0;i<frameSize;i++)
    {
        frame[i] = _in[i];
    }
    P = VAD(frame);
    L = SPL(frame);

    //Make Decision by average
    /*
    float P_dec;
	float L_dec;
	Psum += P;
	Lsum += L;
	Pbuffer[Counter] = P;
	Lbuffer[Counter] = L;

    ++Counter;
    if (Counter == DecisionRate){
    	P_dec = Psum/DecisionRate;
    	L_dec = Lsum/DecisionRate;
    	int filter_final = MakeDecision(P_dec, L_dec);
    	//set 0 after decision
    	Counter = 0;
    	Psum = 0;
    	Lsum = 0;
    }
    */

    //Make Decision by majority voting （Non-overlap)
    if (!overlap) {
		int filterIndex;
		filterIndex = MakeDecision(P, L, NR_flag, WDRC_flag, VAD_T, NR_threshold, WDRC_low_threshold, WDRC_upper_threshold);
		Dbuffer[Counter] = filterIndex;
		++Counter;
		if (Counter == DecisionRate) {
			filter_final = majorityElement(Dbuffer, DecisionRate);
			//set 0 after decision
			Counter = 0;
		}
	}
	//Make Decision by majority voting （with overlap)
	else {
		int filterIndex;
		filterIndex = MakeDecision(P, L, NR_flag, WDRC_flag, VAD_T, NR_threshold, WDRC_low_threshold, WDRC_upper_threshold);
		Dbuffer[Counter + halfDecision ] = filterIndex;
		++Counter;
		if (Counter == DecisionRate / 2) {
			filter_final = majorityElement(Dbuffer, DecisionRate);
			for (i = 0; i < DecisionRate / 2; i++) {
				Dbuffer[i] = Dbuffer[i + halfDecision ];
				Dbuffer[i + halfDecision ] = 0;
			}
			//set 0 after decision
			Counter = 0;
		}
	}

    //filter apply
	float temp;

	for(i=0; i<frameSize; i++)
	{
		buffer[i] = buffer[frameSize + i];
		buffer[frameSize + i] = _in[i];
	}

	for(i=0;i<frameSize;i++)
	{
		temp = 0.0;
		for(j=0;j<order;j++)
		{
			idx = frameSize + (i - j);
			switch(filter_final){
				case 0:
					//temp = buffer[frameSize+i];
					temp += buffer[idx]*coeffs1[j];
					break;
				case 1:
					temp += buffer[idx]*coeffs1[j];
					break;
				case 2:
					temp += buffer[idx]*coeffs2[j];
					break;
				case 3:
					temp += buffer[idx]*coeffs3[j];
					break;
				case 4:
					temp += buffer[idx]*coeffs4[j];
					break;
				case 5:
					temp += buffer[idx]*coeffs5[j];
					break;
				case 6:
					temp += buffer[idx]*coeffs6[j];
					break;
			}

		}

		//checkRange(&temp);
		_output[i] = temp;
	}




	(*env)->ReleaseFloatArrayElements(env, input, _in, 0);
	(*env)->ReleaseFloatArrayElements(env, output, _output, 0);
	return output;

}

jdouble
Java_com_dsp_matlab_Filters_getVAD(JNIEnv *env, jobject thiz)
{
	return round(P*100)/100;
}
jdouble
Java_com_dsp_matlab_Filters_getSPL(JNIEnv *env, jobject thiz)
{
	return round(L*100)/100;;
}

jint
Java_com_dsp_matlab_Filters_getFilter(JNIEnv *env, jobject thiz)
{
	int flag = 2*WDRC_flag+NR_flag+1;
	return flag;
}

void
Java_com_dsp_matlab_Filters_initialize(JNIEnv *env, jobject thiz, int fsize)
{
	frameSize = fsize;
	if(buffer != NULL){
		free(buffer);
		buffer = NULL;
	}
	buffer = (float *) calloc(32+fsize,sizeof(float));
	Pbuffer = (float *) calloc(DecisionRate,sizeof(float));
	Lbuffer = (float *) calloc(DecisionRate,sizeof(float));
	Dbuffer = (int *) calloc(DecisionRate,sizeof(int));
}

void
Java_com_dsp_matlab_Filters_finish(JNIEnv *env, jobject thiz)
{
	if(buffer != NULL){
		free(buffer);
		buffer = NULL;
	}
    if(Dbuffer != NULL){
        free(Dbuffer);
        Dbuffer = NULL;
    }
    WDRC_flag = 0;
    NR_flag = 0;
    Counter = 0;
    filter_final = 0;
}

int MakeDecision(float P_dec, float L_dec, int NR_flag, int WDRC_flag, float VAD_T, int NR_threshold, int WDRC_low_threshold, int WDRC_upper_threshold){
	int nrflag = NR_flag;
	int wdrcflag = WDRC_flag;
	int flag;
	if (P_dec<VAD_T){
		if (L_dec>NR_threshold) {
			nrflag = 1;
		}
		else {
			nrflag = 0;
		}
	}
	else{
		if (L_dec <= WDRC_low_threshold){
			wdrcflag = 0;
		}
		else if (L_dec>WDRC_low_threshold && L_dec <= WDRC_upper_threshold){
			wdrcflag = 1;
		}
		else {
			wdrcflag = 2;
		}
	}

	flag = 2*wdrcflag+nrflag+1;
	return flag;
}

int majorityElement(int* nums, int numsSize)
{
	int result, count = 0,tcount=0, flag = nums[0], i, j;
	for (i = 0; i < numsSize; i++)
	{
		if (i != 0)
		{
			if (nums[i] == flag)
				continue;
			else
				flag = nums[i];
		}

		for (j = 0; j < numsSize; j++)
		{
			if (nums[j] == flag)
				count++;
			else
				count--;
		}
		if (count > tcount)
		{
			tcount = count;
			result = flag;
		}
		count = 0;
	}
	return result;

}